<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Get Data from DOM attribute</title>
	
	
	<style>
		#csvData{
			width: 200px;
			height: 200px;
		}
		
	</style>
	
	<style>

		.bar {
		  fill: steelblue;
		  margin-right: 5px;
		}

		.bar:hover {
		  fill: brown;
		}

		.axis {
		  font: 10px sans-serif;
		}

		.axis path,
		.axis line {
		  fill: none;
		  stroke: #000;
		  shape-rendering: crispEdges;
		}

		.x.axis path {
		  display: none;
		}
	</style>
	
	<!-- Loading d3.js -->
	<script type="text/javascript" src="d3/d3.js"></script>
	
	<script type="text/javascript">
		
		function csv2JSON(csv){		 
			var lines=csv.split("\n");			 
			var result = [];			 
			var headers=lines[0].split(",");			 
			
			for(var i=1;i<lines.length;i++){			 
				var obj = {};
				var currentline=lines[i].split(",");
			 
				for(var j=0;j<headers.length;j++){
					obj[headers[j]] = currentline[j];
				}			 
				result.push(obj);			 
			}			  
			//return result; //JavaScript object
			return JSON.stringify(result); //JSON
		}

		function generateSVG() {
			
			var csvData = document.getElementById('csvData').value;
			var xLabel = document.getElementById('xLabel').value;
			var yLabel = document.getElementById("yLabel").value;

			
			// check yLabel be set up!
			if (!xLabel){
				alert("Please input x axis name");
				return 0;
			}

			if (!yLabel){
				alert("Please input y axis name");
				return 0;
			}
			
			// get JSON data and convert into javascript Object
			var dataset = JSON.parse(csv2JSON(csvData));

			// set SVG width and Height
			var margin = {top: 20, right: 10, bottom: 20, left: 20};

			var width = 950 - margin.left - margin.right, 
				height = 500 - margin.top - margin.bottom;
			
			// set input Scale and output Scale
			xScale = d3.scale.ordinal()
					.domain(dataset.map(function(d){
						return d[xLabel];
					}))
					.rangeRoundBands([0, width], .1);		

			
			yScale = d3.scale.linear()
					.domain([0, d3.max(dataset, function(d){ 
						return d[yLabel]; })])
					.range([height, 0]);

			// set xAxis and yAxis properites
			xAxis = d3.svg.axis()
					.scale(xScale)
					.orient("bottom");

			yAxis = d3.svg.axis()
					.scale(yScale)
					.orient("left")
					.ticks(10) ;
				
			// add SVG element
			var svg = d3.select("body").append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
						.append("g")
						.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


			// set graphy properties
			var rects = svg.selectAll(".bar")
							 .data(dataset)
							 .enter()
						   .append("rect")
							 .attr("class", "bar")
							 .attr("x", function(d){
								return xScale(d[xLabel]);
							 })
							 .attr("y", function(d){
							 	return yScale(parseFloat(d[yLabel]));
							 })
							 .attr("width", xScale.rangeBand())
							 .attr("height", function(d){
							 	return height - yScale(parseFloat(d[yLabel]));
							 })


			// set text properties
			// svg.selectAll("text")
			// 	.data(dataset)
			// 	.enter()
			// 	.append("text")
			// 	.text(function(d){
			// 		return parseFloat(d[yLabel]);
			// 	})
			// 	.attr("text-anchor", "middle")
			// 	.attr("x", function(d, i){
			// 		return i * (width / dataset.length) + (width / dataset.length - barPadding) / 2;
			// 	})
			// 	.attr("y", function(d){
			// 	 	return height - (parseFloat(d[yLabel]) * 4) + 14;
			// 	})
			// 	.attr("font-family", "sans-serif")
			// 	.attr("font-size", "11px")
			// 	.attr("fill", "white")
			
			// draw axis
			svg.append("g")
				.attr("class", "x axis")
				.attr("transform", "translate(0," + height + ")")
				.call(xAxis);

			svg.append("g")
				.attr("class", "y axis")
				.call(yAxis)
			   .append("text")
			   	.attr("transform", "rotate(-90)")
			   	.attr("y", 6)
			   	.attr("dy", ".71em")
			   	.style("text-anchor", "end")
			   	.text(yLabel);

			// add a space line
			d3.select("body").append("br");
		}

		//window.onload = generateSVG;	
	</script>
</head>
<body >
	<div class="container">
		<p>Paste your csvData Below</p>
		<textarea id="csvData"></textarea><br />
		
		<p>輸入x軸欄位名稱</p>
		<textarea id="xLabel"></textarea><br />

		<p>輸入y軸欄位名稱</p>
		<textarea id="yLabel"></textarea><br />
		
		<button onclick="generateSVG();">資料送出</p>	
	</div>
</body>
</html>